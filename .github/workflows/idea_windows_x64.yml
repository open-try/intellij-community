# .github/workflows/idea_windows_x64.yml
name: IntelliJ IDEA — Windows x64 (manual)

on:
  workflow_dispatch: {}

concurrency:
  group: idea-win64-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  PRODUCT: intellij_idea
  TARGET_OS: windows
  TARGET_ARCH: x64
  ARTIFACTS_DIR: out/idea-ce/artifacts
  # Adjust these two if your Dockerfile lives elsewhere
  BUILD_CONTEXT: .
  DOCKERFILE_PATH: ./Dockerfile

jobs:
  build-windows-x64:
    # Manual runs are only allowed on master
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1) Checkout this repo (shallow = latest 1 commit)
      - name: Checkout fork (intellij-community)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2) Compute version tag
      - name: Compute version tag
        id: versioning
        shell: bash
        run: |
          set -euo pipefail
          BUILD_DATE="$(date -u +%Y%m%d)"
          echo "BUILD_DATE=$BUILD_DATE" | tee -a "$GITHUB_ENV"
          VERSION_RAW="$(tr -d '\r\n' < build.txt)"
          echo "VERSION_RAW=$VERSION_RAW" | tee -a "$GITHUB_ENV"
          VERSION_TAG="${VERSION_RAW/SNAPSHOT/${BUILD_DATE}}"
          echo "VERSION_TAG=$VERSION_TAG" | tee -a "$GITHUB_ENV"
          ZIP_NAME="windows-exe-${VERSION_TAG}-unsigned.zip"
          echo "ZIP_NAME=$ZIP_NAME" | tee -a "$GITHUB_ENV"

      # 3) Free disk space safely (does NOT touch workspace)
      - name: Free disk space (remove Android/.NET/Haskell, large pkgs, Docker images, swap)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      # The action above typically recovers ~20–31 GB on ubuntu-latest. [6](https://github.com/jlumbroso/free-disk-space)[7](https://www.yellowduck.be/posts/free-disk-space-ubuntu-github-marketplace)

      # 4) Expand Docker storage ONLY (do not mount over workspace)
      - name: Maximize build space for Docker only
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 512
          temp-reserve-mb: 512
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          # Critical: mount extra space under Docker data dir, not $GITHUB_WORKSPACE
          build-mount-path: '/var/lib/docker'
      # Constraining to /var/lib/docker avoids shadowing the workspace that caused missing files. [1](https://github.com/easimon/maximize-build-space/blob/master/README.md)[2](https://github.com/easimon/maximize-build-space/releases)

      - name: Restart Docker to pick up mount (best effort)
        run: |
          sudo systemctl restart docker || sudo service docker restart
          docker info >/dev/null

      - name: Show disk usage (debug)
        run: df -h

      # 5) Checkout JetBrains/android (shallow, independent default branch)
      - name: Checkout JetBrains/android
        uses: actions/checkout@v4
        with:
          repository: JetBrains/android
          path: android
          fetch-depth: 1
          # If you really must match a branch name, set `ref: ${{ github.ref_name }}`; be aware the branch must exist in that repo.

      # 6) Docker pre-build prune (clean build cache & leftovers)
      - name: Docker pre-build prune
        run: |
          docker builder prune -af || true
          docker system prune -af --volumes || true

      # 7) Assert Dockerfile exists & show context (preflight)
      - name: Verify Dockerfile and context
        shell: bash
        run: |
          set -euo pipefail
          echo "Looking for Dockerfile at: ${DOCKERFILE_PATH}"
          test -f "${DOCKERFILE_PATH}" || { echo "::error::Dockerfile not found at ${DOCKERFILE_PATH}. Update DOCKERFILE_PATH or move the file."; exit 1; }
          echo "Build context contents (top-level):"
          ls -la "${BUILD_CONTEXT}"

      # 8) Build Docker environment image (multi-stage target = PRODUCT)
      #    If your Dockerfile is not at repo root, the -f and context ensure correct resolution.
      - name: Build Docker environment for ${{ env.PRODUCT }}
        shell: bash
        run: |
          docker build "${BUILD_CONTEXT}" \
            -f "${DOCKERFILE_PATH}" \
            --target "${PRODUCT}" \
            --tag "${PRODUCT}"

      # 9) Build Windows x64 .exe via Docker
      - name: Build Windows x64 .exe via Docker
        shell: bash
        run: |
          docker run --rm \
            --user "$(id -u)" \
            --volume "${PWD}:/community" \
            "${PRODUCT}" \
              -Dintellij.build.target.os="${TARGET_OS}" \
              -Dintellij.build.target.arch="${TARGET_ARCH}" \
              -Dintellij.build.skip.build.steps=windows_zip_archive

      # 10) List produced files (debug)
      - name: List produced files (debug)
        if: always()
        run: |
          echo "Contents of ${ARTIFACTS_DIR}:"
          ls -lah "${ARTIFACTS_DIR}" || true

      # 11) Checksums (exe and SPDX if present)
      - name: Generate SHA-256 checksums
        shell: bash
        run: |
          set -euo pipefail
          checksum() {
            local f="$1"
            if [ "$(uname)" = "Darwin" ]; then shasum --algorithm 256 --binary "$f" > "$f.sha256"
            else sha256sum --binary "$f" > "$f.sha256"; fi
          }
          cd "${ARTIFACTS_DIR}"
          shopt -s nullglob
          for it in *.exe *.exe.spdx.json; do
            [ -e "$it" ] || continue
            echo "checksum: $it"
            checksum "$it"
          done

      # 12) Package unsigned exe into versioned zip
      - name: Package unsigned Windows exe into versioned zip
        shell: bash
        run: |
          set -euo pipefail
          cd "${ARTIFACTS_DIR}"
          ZIP_PATH="${{ github.workspace }}/${ZIP_NAME}"
          ls -l *.exe
          # try include SPDX and checksums if available
          zip -9 -y "$ZIP_PATH" *.exe *.spdx.json *.sha256 2>/dev/null || true
          # ensure at least the exe is packed
          zip -9 -y "$ZIP_PATH" *.exe
          echo "ZIP_PATH=$ZIP_PATH" >> "$GITHUB_ENV"

      - name: Upload versioned zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          if-no-files-found: error
          retention-days: 1
          path: ${{ env.ZIP_PATH }}

      # 13) Cleanup (Docker + workspace) after upload
      - name: Cleanup (Docker, workspace)
        if: always()
        shell: bash
        run: |
          set -euxo pipefail
          echo "::group::Docker cleanup"
          docker ps -aq | xargs -r docker rm -f || true
          docker images --format '{{.Repository}}:{{.Tag}}' | grep -E "^${PRODUCT}:" | xargs -r docker rmi -f || true
          docker builder prune -af || true
          docker image prune -af || true
          docker container prune -f || true
          docker volume prune -f || true
          docker system prune -af --volumes || true
          echo "::endgroup::"

          echo "::group::Workspace cleanup"
          rm -rf "${ARTIFACTS_DIR}" android out || true
          git clean -ffdx || true
          echo "::endgroup::"
